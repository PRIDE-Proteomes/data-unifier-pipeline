<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:batch="http://www.springframework.org/schema/batch"
       xmlns:util="http://www.springframework.org/schema/util"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/batch
       http://www.springframework.org/schema/batch/spring-batch.xsd http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd">

    <batch:step id="partitionReleaseReportPeptideMappingStep">
        <batch:tasklet start-limit="5" transaction-manager="transactionManager">
            <batch:chunk reader="releaseReportPeptideMappingReader"
                         processor="releaseReportPeptideMappingReportCompositeItemProcessor"
                         writer="releaseReportPeptideMappingWriter"
                         commit-interval="250" skip-limit="99999">
                <batch:skippable-exception-classes>
                    <batch:include class="org.springframework.batch.item.validator.ValidationException"/>
                </batch:skippable-exception-classes>
                <batch:streams>
                    <batch:stream ref="releaseUniquePeptidesReportPeptideMappingWriter" />
                    <batch:stream ref="releaseGeneralReportPeptideMappingWriter" />
                </batch:streams>
            </batch:chunk>
        </batch:tasklet>
        <batch:listeners>
            <batch:listener ref="stepListener"/>
            <batch:listener ref="writeListener"/>
            <batch:listener ref="headerCallback"/>
        </batch:listeners>
    </batch:step>

    <!-- reader -->
    <bean id="releaseReportPeptideMappingReader" scope="step"
          class="org.springframework.batch.item.database.JdbcPagingItemReader">
        <property name="dataSource" ref="proteomesDataSource"/>
        <property name="queryProvider">
            <bean class="org.springframework.batch.item.database.support.SqlPagingQueryProviderFactoryBean">
                <property name="dataSource" ref="proteomesDataSource"/>
                <property name="selectClause">
                    <value>
                        <![CDATA[
                            PROTEIN_MAPPING.PEPTIDE_ID           AS PEPTIDE_ID,
                            PROTEIN_MAPPING.PEPTIDE_SEQUENCE     AS PEPTIDE_SEQUENCE,
                            PROTEIN_MAPPING.START_POSITION       AS START_POSITION,
                            PROTEIN_MAPPING.NUM_PROTEIN_MAPPINGS AS NUM_PROTEIN_MAPPINGS,
                            PROTEIN_MAPPING.PROTEIN_ACCESSION    AS PROTEIN_ACCESSION,
                            PROTEIN_MAPPING.PROTEIN_EVIDENCE     AS PROTEIN_EVIDENCE,
                            GENE_MAPPING.NUM_GENE_MAPPINGS       AS NUM_GENE_MAPPINGS,
                            GENE_MAPPING.GENE_ID                 AS GENE_ID,
                            PROTEIN_MAPPING.TAXID                AS TAXID
                        ]]>
                    </value>
                </property>
                <property name="fromClause" >
                    <value>
                        <![CDATA[
                              (select PEPTIDE.PEPTIDE_ID as PEPTIDE_ID,
                                PEPTIDE.sequence         as PEPTIDE_SEQUENCE,
                                PEP_PROT.START_POSITION  as START_POSITION,
                                PEP_PROT.UNIQUENESS      as NUM_PROTEIN_MAPPINGS,
                                PEP_PROT.PROTEIN_ID      as PROTEIN_ACCESSION,
                                PROTEIN.EVIDENCE         as PROTEIN_EVIDENCE,
                                PROT_GENES.PROT_GROUP_ID as GENE_ID,
                                PEPTIDE.TAXID            as TAXID
                              from PRIDEPROT.PEPTIDE,
                                PRIDEPROT.PEP_PROT,
                                PRIDEPROT.PROTEIN
                              left join
                                (select PROT_PGRP.PROT_GROUP_ID,
                                  PROT_PGRP.PROTEIN_ID
                                from PRIDEPROT.PROT_GROUP,
                                  PRIDEPROT.PROT_PGRP
                                where PROT_GROUP.PROT_GROUP_ID = PROT_PGRP.PROT_GROUP_ID
                                and PROT_GROUP.PROT_GROUP_TYPE ='GENE'
                                ) PROT_GENES
                              on PROT_GENES.PROTEIN_ID = PROTEIN.PROTEIN_ID
                              and PROTEIN.CONTAMINANT  = 'F'
                              where PEPTIDE.PEPTIDE_ID = PEP_PROT.PEPTIDE_ID
                              and PROTEIN.PROTEIN_ID   = PEP_PROT.PROTEIN_ID
                              and PEPTIDE.SYMBOLIC     ='TRUE'
                              and PEPTIDE.TAXID        = :TAXID
                              )PROTEIN_MAPPING
                            full outer join
                              (select PEP_TO_PROTS.PEPTIDE_ID      as PEPTIDE_ID,
                                PEP_TO_PROTS.sequence              as PEPTIDE_SEQUENCE,
                                PRIDEPROT.PEP_PGROUP.UNIQUENESS    as NUM_GENE_MAPPINGS,
                                PRIDEPROT.PEP_PGROUP.PROT_GROUP_ID as GENE_ID,
                                PEP_TO_PROTS.TAXID                 as TAXID
                              from
                                (select distinct PEPTIDE.PEPTIDE_ID ,
                                  PEPTIDE.SYMBOLIC,
                                  PEPTIDE.sequence,
                                  PEPTIDE.TAXID
                                from PRIDEPROT.PEPTIDE,
                                  PRIDEPROT.PEP_PROT,
                                  PRIDEPROT.PROTEIN
                                where
                                  PEPTIDE.PEPTIDE_ID=PEP_PROT.PEPTIDE_ID
                                  and PEP_PROT.PROTEIN_ID =PROTEIN.PROTEIN_ID
                                  and PROTEIN.CONTAMINANT = 'F'
                                ) PEP_TO_PROTS
                              left join PRIDEPROT.PEP_PGROUP
                              on PEP_TO_PROTS.PEPTIDE_ID                  = PEP_PGROUP.PEPTIDE_ID
                              and PEP_PGROUP.PROT_GROUP_TYPE              ='GENE'
                              and PEP_TO_PROTS.SYMBOLIC                   ='TRUE'
                              and PEP_TO_PROTS.TAXID                      = :TAXID
                              ) GENE_MAPPING
                            on PROTEIN_MAPPING.PEPTIDE_ID                 =GENE_MAPPING.PEPTIDE_ID
                            and PROTEIN_MAPPING.PEPTIDE_SEQUENCE          =GENE_MAPPING.PEPTIDE_SEQUENCE
                            and PROTEIN_MAPPING.GENE_ID                   =GENE_MAPPING.GENE_ID
                           ]]>
                    </value>
                </property>
                <property name="sortKeys">
                    <map>
                        <entry key="PEPTIDE_SEQUENCE" value="ASCENDING" />
                    </map>
                </property>
            </bean>
        </property>
        <property name="parameterValues">
            <map>
                <entry key="taxid" value="#{stepExecutionContext['taxid']}"/>
            </map>
        </property>
        <property name="pageSize" value="500"/>
        <property name="rowMapper">
            <bean class="uk.ac.ebi.pride.proteomes.pipeline.unifier.release.report.PeptideMappingRowMapper"/>
        </property>
        <property name="fetchSize" value="1000"/>
    </bean>

    <!-- processor -->
    <bean id="releaseReportPeptideMappingReportCompositeItemProcessor"
          class="org.springframework.batch.item.support.CompositeItemProcessor">
        <property name="delegates">
            <list>
                <ref bean="releaseReportPeptideMappingValidator"/>
                <ref bean="releaseReportPeptideMappingProcessor"/>
            </list>
        </property>
    </bean>

    <!-- validator/processor -->
    <bean id="releaseReportPeptideMappingValidator"
          class="org.springframework.batch.item.validator.ValidatingItemProcessor">
        <property name="filter" value="false"/>
        <property name="validator" ref="defaultValidator"/>
    </bean>

    <bean id="releaseReportPeptideMappingProcessor"
          class="uk.ac.ebi.pride.proteomes.pipeline.unifier.release.report.PeptideMappingProcessor"/>


    <!-- writer -->
    <bean id="releaseReportPeptideMappingWriter" scope="step"
          class="org.springframework.batch.item.support.ClassifierCompositeItemWriter">
        <property name="classifier">
            <bean class="org.springframework.classify.BackToBackPatternClassifier">
                <property name="routerDelegate">
                    <bean class="uk.ac.ebi.pride.proteomes.pipeline.unifier.release.report.classifier.UniquePeptideClassifier" />
                </property>
                <property name="matcherMap">
                    <map>
                        <entry key="true"
                               value-ref="releaseUniquePeptidesReportPeptideMappingWriter" />
                        <entry key="*"
                               value-ref="releaseGeneralReportPeptideMappingWriter" />
                    </map>
                </property>
            </bean>
        </property>
    </bean>

    <bean id="releaseGeneralReportPeptideMappingWriter"  scope="step" class="org.springframework.batch.item.file.FlatFileItemWriter">
        <property name="resource"
                  value="file:${output.file.dir}#{stepExecutionContext['taxid']}/${peptide.mapping.report.prefix}#{stepExecutionContext['taxid']}${peptide.mapping.report.postfix}.tsv"/>
        <property name="headerCallback" ref="headerCallback"/>
        <property name="lineAggregator">
            <bean class="org.springframework.batch.item.file.transform.DelimitedLineAggregator">
                <property name="delimiter">
                    <util:constant
                            static-field="org.springframework.batch.item.file.transform.DelimitedLineTokenizer.DELIMITER_TAB"/>
                </property>
                <property name="fieldExtractor">
                    <bean class="org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor">
                        <property name="names"
                                  value="peptideSequence, startPosition, length, numProteinMappings, uniquePeptideToProtein, proteinAccession, proteinEvidence, numGeneMappings, uniquePeptideToGene, gene, tissues, taxid"/>
                    </bean>
                </property>
            </bean>

        </property>
    </bean>

    <bean id="releaseUniquePeptidesReportPeptideMappingWriter"  scope="step" class="org.springframework.batch.item.file.FlatFileItemWriter">
        <property name="resource"
                  value="file:${output.file.dir}#{stepExecutionContext['taxid']}/${unique.peptide.mapping.report.prefix}#{stepExecutionContext['taxid']}${unique.peptide.mapping.report.postfix}.tsv"/>
        <property name="headerCallback" ref="headerCallback"/>
        <property name="lineAggregator">
            <bean class="org.springframework.batch.item.file.transform.DelimitedLineAggregator">
                <property name="delimiter">
                    <util:constant
                            static-field="org.springframework.batch.item.file.transform.DelimitedLineTokenizer.DELIMITER_TAB"/>
                </property>
                <property name="fieldExtractor">
                    <bean class="org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor">
                        <property name="names"
                                  value="peptideSequence, startPosition, length, numProteinMappings, uniquePeptideToProtein, proteinAccession, proteinEvidence, numGeneMappings, uniquePeptideToGene, gene, tissues, taxid"/>
                    </bean>
                </property>
            </bean>

        </property>
    </bean>

    <bean id="headerCallback"
          class="uk.ac.ebi.pride.proteomes.pipeline.unifier.release.report.callback.ReleaseReportPeptideMappingHeaderCallback"/>
</beans>
